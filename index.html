<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Canlı Destek Puanlama</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark }
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(37,255,230,.08), transparent 60%),
        radial-gradient(900px 500px at 100% 0%, rgba(13,197,255,.08), transparent 50%),
        #0a0f1e;
      color:#e9eef5
    }
    .card{background:#0f172a; border:1px solid #1f2a44; border-radius:16px; box-shadow:0 12px 36px rgba(0,0,0,.35)}
    .input{background:#0b1430; border:1px solid #243055; border-radius:12px; padding:.9rem 1rem; width:100%}
    .input:focus{outline:2px solid #0DC5FF; border-color:#0DC5FF}
    .btn{padding:.85rem 1rem; border-radius:12px; font-weight:700}
    .btn-primary{background:#0DC5FF}
    .btn-ghost{border:1px solid #2a3658}
    .badge{padding:.25rem .55rem; border-radius:.5rem; font-size:.75rem; font-weight:700; border:1px solid rgba(255,255,255,.12)}
    .badge-admin{background:rgba(255,193,7,.12); color:#ffc107}
    .badge-operator{background:rgba(13,197,255,.12); color:#0DC5FF}
    .badge-follower{background:rgba(37,255,230,.12); color:#25FFE6}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="border-b border-[#1f2a44]">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-6 h-6 rounded-md" style="background:linear-gradient(135deg,#25FFE6,#0DC5FF)"></div>
        <div>
          <h1 class="text-lg font-extrabold tracking-tight">Canlı Destek Puanlama</h1>
          <p class="text-xs opacity-60 -mt-1">Giriş yap, profilin otomatik oluşsun.</p>
        </div>
      </div>
      <div id="user-chip" class="hidden items-center gap-3">
        <span id="chip-email" class="text-sm opacity-90"></span>
        <span id="chip-role" class="badge"></span>
        <button id="btn-logout" class="btn btn-ghost text-sm">Çıkış</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-6 py-10">
    <div id="auth-card" class="card p-8 max-w-xl mx-auto">
      <div class="flex gap-2 mb-6">
        <button id="tab-login" class="btn btn-ghost w-1/2 font-semibold">Giriş Yap</button>
        <button id="tab-register" class="btn btn-ghost w-1/2 font-semibold opacity-70">Kayıt Ol</button>
      </div>

      <form id="form-login" class="space-y-5">
        <div>
          <label class="block mb-2 text-sm opacity-80">E-posta</label>
          <input id="login-email" type="email" required placeholder="ornek@mail.com" class="input">
        </div>
        <div>
          <label class="block mb-2 text-sm opacity-80">Şifre</label>
          <div class="relative">
            <input id="login-password" type="password" minlength="6" required placeholder="••••••" class="input pr-12">
            <button type="button" id="toggle-login-pass" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs opacity-70">Göster</button>
          </div>
        </div>
        <button class="btn btn-primary w-full">Giriş Yap</button>
        <p class="text-yellow-300/90 text-sm">İlk girişte profiliniz otomatik oluşur. Admin, rolünüzü (admin / operator / follower) güncelleyebilir.</p>
        <p id="msg-login" class="text-sm mt-1 opacity-90"></p>
      </form>

      <form id="form-register" class="space-y-5 hidden">
        <div>
          <label class="block mb-2 text-sm opacity-80">E-posta</label>
          <input id="reg-email" type="email" required placeholder="ornek@mail.com" class="input">
        </div>
        <div>
          <label class="block mb-2 text-sm opacity-80">Şifre</label>
          <div class="relative">
            <input id="reg-password" type="password" minlength="6" required placeholder="••••••" class="input pr-12">
            <button type="button" id="toggle-reg-pass" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs opacity-70">Göster</button>
          </div>
        </div>
        <button class="btn btn-primary w-full">Kayıt Ol</button>
        <p id="msg-register" class="text-sm mt-1 opacity-90"></p>
      </form>
    </div>

    <!-- Dashboard -->
    <section id="app" class="hidden grid lg:grid-cols-3 gap-6">
      <!-- Left: Profile -->
      <div class="card p-6 lg:col-span-1">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-xl font-bold">Profil</h3>
            <p class="text-sm opacity-70">Kullanıcı bilgilerin</p>
          </div>
          <span id="role-badge" class="badge">role</span>
        </div>
        <div class="mt-4 space-y-2 text-sm">
          <div class="opacity-70">E-posta</div>
          <div id="profile-email" class="font-semibold"></div>
          <div class="opacity-70 pt-3">Kullanıcı ID</div>
          <div id="profile-id" class="font-mono text-xs break-all opacity-90"></div>
          <div class="opacity-70 pt-3">Oluşturulma</div>
          <div id="profile-created" class="opacity-90"></div>
        </div>
      </div>

      <!-- Middle: Quick actions -->
      <div class="card p-6 lg:col-span-2">
        <h3 class="text-xl font-bold mb-2">Hızlı İşlemler</h3>
        <p class="text-sm opacity-70 mb-6">Buraya daha sonra “puanlama”, “operatör profilleri”, “raporlar” gibi modülleri ekleyebiliriz.</p>

        <div id="admin-tools" class="hidden">
          <h4 class="font-semibold mb-2">Admin: Rol Atama</h4>
          <div class="grid md:grid-cols-[1fr_180px_120px] gap-3">
            <input id="adm-email" type="email" placeholder="kisi@ornek.com" class="input">
            <select id="adm-role" class="input">
              <option value="admin">admin</option>
              <option value="operator">operator</option>
              <option value="follower">follower</option>
            </select>
            <button id="adm-apply" class="btn btn-ghost">Uygula</button>
          </div>
          <p id="msg-admin" class="text-sm opacity-90 mt-2"></p>
          <hr class="border-[#1f2a44] my-6">
        </div>

        <div class="grid md:grid-cols-2 gap-4">
          <button id="btn-refresh" class="btn btn-ghost">Profili Yenile</button>
          <button id="btn-signout" class="btn btn-ghost">Güvenli Çıkış</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // === Supabase config (Senin verdiğin değerlerle dolduruldu) ===
    const SUPABASE_URL = "https://swsxpdzjxofajjhlqnsl.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3c3hwZHpqeG9mYWpqaGxxbnNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNzY1MzUsImV4cCI6MjA3NDY1MjUzNX0.nD4qPHLk35pX7MlirXLNkfSbjdyd4ac5iuzY-hiGL5I";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    // === UI helpers ===
    const $ = s => document.querySelector(s);
    const show = (el, flag) => el.classList.toggle('hidden', !flag);
    const setText = (el, txt) => el.textContent = txt ?? '';

    // Tabs
    const tabLogin = $('#tab-login'), tabRegister = $('#tab-register');
    const formLogin = $('#form-login'), formRegister = $('#form-register');
    tabLogin.onclick = () => { tabLogin.classList.remove('opacity-70'); tabRegister.classList.add('opacity-70'); show(formLogin,true); show(formRegister,false); }
    tabRegister.onclick = () => { tabRegister.classList.remove('opacity-70'); tabLogin.classList.add('opacity-70'); show(formLogin,false); show(formRegister,true); }

    // Password toggles
    $('#toggle-login-pass').onclick = () => {
      const i = $('#login-password'); i.type = i.type === 'password' ? 'text' : 'password';
      $('#toggle-login-pass').textContent = i.type === 'password' ? 'Göster' : 'Gizle';
    };
    $('#toggle-reg-pass').onclick = () => {
      const i = $('#reg-password'); i.type = i.type === 'password' ? 'text' : 'password';
      $('#toggle-reg-pass').textContent = i.type === 'password' ? 'Göster' : 'Gizle';
    };

    // Auth DOM
    const authCard = $('#auth-card');
    const app = $('#app');
    const userChip = $('#user-chip');
    const chipEmail = $('#chip-email');
    const chipRole = $('#chip-role');
    const roleBadge = $('#role-badge');
    const msgLogin = $('#msg-login');
    const msgRegister = $('#msg-register');

    // Load profile
    async function loadProfile() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;
      setText(chipEmail, user.email);
      $('#profile-email').textContent = user.email;
      $('#profile-id').textContent = user.id;
      // get profile row
      const { data, error } = await supabase.from('profiles')
        .select('id,email,role,created_at')
        .eq('id', user.id)
        .single();
      if (error) {
        chipRole.className = 'badge';
        chipRole.textContent = 'profil yok';
        roleBadge.className = 'badge';
        roleBadge.textContent = 'profil yok';
        return;
      }
      const role = (data.role || 'follower');
      const created = new Date(data.created_at).toLocaleString();
      $('#profile-created').textContent = created;

      // badges
      const roleClass = role === 'admin' ? 'badge-admin' : role === 'operator' ? 'badge-operator' : 'badge-follower';
      chipRole.className = `badge ${roleClass}`;
      roleBadge.className = `badge ${roleClass}`;
      chipRole.textContent = role;
      roleBadge.textContent = role;

      // admin tools
      show($('#admin-tools'), role === 'admin');
    }

    // Login
    formLogin.addEventListener('submit', async (e) => {
      e.preventDefault();
      setText(msgLogin, 'Giriş yapılıyor…');
      const email = $('#login-email').value.trim();
      const password = $('#login-password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) {
        if (error.message.includes('Invalid login credentials')) {
          setText(msgLogin, 'Bilgiler hatalı. Kayıt sekmesinden yeni hesap oluşturabilirsiniz.');
        } else {
          setText(msgLogin, 'Giriş hatası: ' + error.message);
        }
        return;
      }
      setText(msgLogin, 'Giriş başarılı.');
      show(authCard, false); show(app, true); show(userChip, true);
      await loadProfile();
    });

    // Register
    formRegister.addEventListener('submit', async (e) => {
      e.preventDefault();
      setText(msgRegister, 'Kayıt oluşturuluyor…');
      const email = $('#reg-email').value.trim();
      const password = $('#reg-password').value;
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) { setText(msgRegister, 'Kayıt hatası: ' + error.message); return; }
      setText(msgRegister, 'Kayıt başarılı. E-posta doğrulaması gerekebilir. Giriş sekmesinden devam edin.');
    });

    // Global sign out buttons
    $('#btn-signout').onclick = $('#btn-logout').onclick = async () => {
      await supabase.auth.signOut(); location.reload();
    };

    // Admin: role assign
    $('#adm-apply').onclick = async () => {
      const email = $('#adm-email').value.trim();
      const role = $('#adm-role').value;
      const msg = $('#msg-admin');
      msg.textContent = 'Uygulanıyor…';
      // find profile by email
      const { data: prof, error: e1 } = await supabase.from('profiles').select('id,email').eq('email', email).single();
      if (e1) { msg.textContent = 'Bulunamadı: ' + e1.message; return; }
      const { error: e2 } = await supabase.from('profiles').update({ role }).eq('id', prof.id);
      msg.textContent = e2 ? ('Hata: ' + e2.message) : 'Rol güncellendi ✅';
    };

    // Refresh
    $('#btn-refresh').onclick = loadProfile;

    // On page load: session?
    supabase.auth.onAuthStateChange(async (_event, session) => {
      if (session) {
        show(authCard, false); show(app, true); show(userChip, true);
        await loadProfile();
      }
    });
    (async () => {
      const { data: { user } } = await supabase.auth.getUser();
      if (user) { show(authCard, false); show(app, true); show(userChip, true); loadProfile(); }
    })();
  </script>
</body>
</html>
